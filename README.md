# Cache Test Controller

This cloud function script runs visual regression tests, comparing screenshots of a website from a base location to screenshots taken from different origin points. Failing tests are saved in a cloud bucket and sent to a slack channel.

## Setup

### Screenshot Cloud Function
This script requires multiple screen grabber cloud functions to be running in different locations. These functions load the selected site from their origin point and return a screenshot. You can copy the code from the `screenGrabber` repo and create cloud function with it. Make sure that the cloud function is `2nd generation`, and that the endpoint can be executed without privileges. Once the function is running you can visit the endpoint and append a URL to screenshot. 

ex: `https://screen-grabber-australia-zilbgc6v4a-ts.a.run.app/?url=https://www.gfinityesports.com/`

This will return a screenshot of the website from the functions location. You can then copy this function to any data-center location.

### Main Regression Test Cloud Function
You can create another cloud function using the main files in the repo. 
```
- config.js
- index.js
- slack.js
- package.json
```
Several env variables need to be set up in order for the main regression test script to work, these are listed below.
```
TOKEN=
SLACK_URL=
BUCKET=
PROJECTID=
```
The token is a string that will be used to prevent unauthorized requests. This is appended to cron requests as a query parameter.
The slack URL is the webhook URL generated by the slack app. 
The bucket is the name of the GC bucket you want screenshots to be saved in. And the project ID is the ID of the GC project.

A config.json file also needs to be created. This will list all screenshot cloud functions and their locations, set a base location to which all screenshots will be compared to and list the sites to test.
```
{
	"sites": [
		{
		"name": "Epicstream",
		"url": "https://epicstream.com/"
		}
	],
	"base": {
		"name": "(London, UK) Europe-West-2",
		"edge": "https://screen-grabber-base-united-kingdom-zilbgc6v2344a-nw.a.run.app"
	},
	"locations": [
		{
		"name": "(Mumbai, India) Asia-South-1",
		"edge": "https://screen-grabber-india-zilb423gc6v4a-el.a.run.app"
		},
		{
		"name": "(Warsaw, Poland) Europe-Central-2",
		"edge": "https://screen-grabber-poland-zil243bgc6v4a-lm.a.run.app"
		}
	]
}
```
Finally a service worker JSON file with r/w permissions needs to be added to the root directory so the script can create and read regression images.

## Running

Once the screenshot functions and main regression test function are set up. A cron can be created that will hit the regression test endpoint with the token parameter, which will start the tests. Updates will be sent to the Slack channel configured in the Slack app.